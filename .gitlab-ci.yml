image: docker:18.09.7

stages:
    - build
    - test
    - deploy

variables:
    CURRENT_VER: $IMAGE_NAME:$CI_COMMIT_TAG
    LATEST_VER: $IMAGE_NAME:latest

services:
    - docker:18.09-dind

cache:
  paths:
  - node_modules/

default:
    before_script:
        - docker info
        - apk add --update nodejs npm
        - npm install
        - npm install react-scripts -g

build_image:
    stage: build
    script:
        - npm run build
        - docker build -t $CURRENT_VER -t $LATEST_VER .

test_script:
    stage: test
    script:
        - npm run test
        - docker run $CURRENT_VER

deploy_prod:
    stage: deploy
    only:
        - tags
    script:
        - docker login -u "$DOCKER_USER" -p "$DOCKER_TOKEN"
        - docker tag $CURRENT_VER && docker tag $LATEST_VER
        - docker push $CURRENT_VER && docker push $LATEST_VER